# RSYNC NFe server FIGRANA <= NETFIMATEC

### Objetivo:
; Copiar as NFe do local atual em (SERVIDOR ORIGEM) para o (SERVIDOR DESTINO) onde roda o FIGRANA
; Copiar apenas o que foi modificado e incluido
; Isso deve rodar a cada 5 minutos (depois de completada a carga inicial), para permitir o sincronismo

## Criar o diretorio onde ficarão as NFe (SERVIDOR DESTINO)
; mkdir /var/nfe
; chmod -R 777 /var/nfe

## Criar as chaves no servidor do FIGRANA, usando o USER que fará a chama CRON (SERVIDOR DESTINO)
; ssh-keygen -f ~/.ssh/id_rsa -q -P ""
; cat ~/.ssh/id_rsa.pub

## Copiar a chave criada para o servidor ORIGEM (SERVIDOR DESTINO)

; scp ~/.ssh/id_rsa.pub root@192.168.0.2:~/figrana_key.pub

## No (SERVIDOR ORIGEM) criar a pasta e o arquivo (caso ainda não existam)

; mkdir ~/.ssh
; chmod 0700 ~/.ssh
; touch ~/.ssh/authorized_keys
; chmod 0644 ~/.ssh/authorized_keys

## Colocar a chave criada na pasta authorized_keys (SERVIDOR ORIGEM)

; cat ~/figrana_key.pub >> ~/.ssh/authorized_keys

# Criar o JOB BASH do rsync (SERVIDOR DESTINO)

; nano /var/www/figrana/jobs/job_rsync_nfe.sh
#! /bin/bash
rsync -avz -e 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null' root@192.168.0.2:/var/www/nfe/ /var/nfe
chmod -R 777 /var/nfe

## Criar CRON JOB que será executado a cada 5 minutos (SERVIDOR DESTINO)
; Usar o WEBMIN ou 
; cd /etc/cron.d
; nano job_rsync_nfe

# Tarefa de sincronizacao das NFe
# Essa tarefa será executada
# */5  = a cada 5 minutos,
# 6-21 = das 6 às 21 horas,
# *    = todos os dias,
# *    = todos os meses,
# 1-6  = mas apenas de segunda a sábado
*/5 6-21 * * 1-6 root php /var/www/figrana/jobs/job_rsync_nfe.sh &> /dev/null







